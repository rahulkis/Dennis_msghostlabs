!function(e,t){e(function(){function i(t,i){!1!==t&&(t=!0),i||(i=_.find(".show_if_giftcard")),i.each(function(i){var a=e(this),n=a.find(".show_if_giftcard_simple"),c=a.find(".show_if_giftcard_variable");t?a.show():a.hide(),"simple"===f&&(t?c.hide():c.show(),n.length&&(t?n.show():n.hide())),"variable"===f&&(t?n.hide():n.show(),c.length&&(t?c.show():c.hide()))})}function a(t){i(),o.prop("checked","checked").change(),d.attr("class","tips"),d.hide(),t&&"undefined"!=t||u.val("none"),h.length&&h.find(".variable_is_virtual").prop("checked","checked").each(function(){var t=e(this);t.change(),t.parent().hide()})}function n(t){i(!1),d.attr("class",l.join(" ")),o.prop("checked",s?"checked":null).change(),-1!==e.inArray("show_if_"+f,l)&&d.show(),t&&"undefined"!=t||u.val(p),h.length&&h.find(".variable_is_virtual").each(function(){e(this).parent().show()})}function c(){_.find(".template_default_image_container").each(function(t){var i=e(this),a=i.find("#_gift_card_template_default_use_image"),n=i.find(".gift_card_template_default_custom_image"),c=i.find(".wc_gc_field_select_image"),r=i.find(".wc_gc_field_remove_image");"custom"===a.val()&&n.show(),a.on("change",function(){"custom"===a.val()?n.show():n.hide()}),r.on("click",function(t){var i=e(this),a=i.closest(".wc_gc_select_image"),n=a.find(".wc_gc_field_select_image");t.preventDefault(),n.removeClass("has_image"),i.removeClass("has_image"),a.find("input").val("").change(),n.find("img").eq(0).attr("src",wc_gc_admin_params.wc_placeholder_img_src)});var _=null;c.on("click",function(t){t.preventDefault();var i=e(this);_?_.open():((_=wp.media({title:wc_gc_admin_params.i18n_select_image_frame_title,button:{text:wc_gc_admin_params.i18n_select_image_frame_button},states:[new wp.media.controller.Library({title:wc_gc_admin_params.i18n_select_image_frame_title,filterable:"all"})]})).on("select",function(){var e=_.state().get("selection").first().toJSON(),t=e.sizes&&e.sizes.thumbnail?e.sizes.thumbnail.url:e.url;i.addClass("has_image"),i.closest(".wc_gc_select_image").find(".wc_gc_field_remove_image").addClass("has_image"),i.find("input").val(e.id).change(),i.find("img").eq(0).attr("src",t)}),_.open())})})}e(document.body).on("wc-init-datepickers",function(){e(".date-picker-field, .date-picker").datepicker({dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0})}).trigger("wc-init-datepickers"),e(".woocommerce-gc-giftcards #delete-action").on("click",function(e){if(!t.confirm(wc_gc_admin_params.i18n_wc_delete_card_warning))return e.preventDefault(),!1}),e("#giftcards-table #doaction").on("click",function(i){if("delete"===e("#bulk-action-selector-top").val()&&!t.confirm(wc_gc_admin_params.i18n_wc_bulk_delete_card_warning))return i.preventDefault(),!1}),e("#giftcards-table #doaction2").on("click",function(i){if("delete"===e("#bulk-action-selector-bottom").val()&&!t.confirm(wc_gc_admin_params.i18n_wc_bulk_delete_card_warning))return i.preventDefault(),!1});var r=function(){var i=e(".wc-gc-message-mask");if(!i.length)return!1;var a=!1,n=i.find(".wc-gc-message-mask_placeholder"),c=i.find("#wc_gc_replace_message_cancel").hide(),r=i.find("textarea"),_=e("#edit-gift-card-form"),o=function(){a?n.hide():n.fadeIn("fast")},d=function(){a?(a=!1,r.hide(),c.hide()):(r.fadeIn("fast"),c.fadeIn("fast"),a=!0)};return{hook:function(){i.on("click","#wc_gc_replace_message_action, #wc_gc_replace_message_cancel",function(e){return e.preventDefault(),d(),o(),!1}),_.on("submit",function(e){return!(a&&!t.confirm(wc_gc_admin_params.i18n_wc_edit_message_warning)&&(e.preventDefault(),1))})}}}();r&&r.hook(),{$order_items_wrapper:e("#woocommerce-order-items"),view:!1,init:function(){this.$order_items_wrapper.length&&this.$order_items_wrapper.on("click","button.add-gift-card",this.add_gift_card.bind(this)).on("click","a.delete-gift-card-item",this.delete_gift_card.bind(this)).on("click","button.configure_gift_card",{action:"configure"},this.clicked_edit_button.bind(this)).on("click","button.edit_gift_card",{action:"edit"},this.clicked_edit_button.bind(this))},reloaded_items:function(){"yes"===wc_gc_admin_params.is_wc_version_gte_3_4?this.$order_items_wrapper.trigger("wc_order_items_reloaded"):(this.core.init_tiptip(),this.core.stupidtable.init())},block:function(t,i){t&&"undefined"!==t||(t=this.$order_items_wrapper);var a={message:null,overlayCSS:{background:"#fff",opacity:.6}},n=e.extend({},a,i||{});t.block(n)},unblock:function(e){e&&"undefined"!==e||(e=this.$order_items_wrapper),e.unblock()},clicked_edit_button:function(t){var i=e.WCBackboneModal.View.extend({addButton:this.clicked_done_button.bind(this)}),a=e(t.target).closest("tr.item").attr("data-order_item_id");return this.view=new i({target:"wc-modal-edit-gift-card",string:{action:"configure"===t.data.action?wc_gc_admin_params.i18n_configure_order_item:wc_gc_admin_params.i18n_edit_order_item,item_id:a}}),this.populate_form.call(this),!1},clicked_done_button:function(i){this.block(this.view.$el.find(".wc-backbone-modal-content"));var a=e.extend({},this.get_taxable_address(),{action:"wc_gc_edit_order_item_gift_card_in_order",item_id:this.view._string.item_id,fields:this.view.$el.find("input, select, textarea").serialize(),dataType:"json",order_id:woocommerce_admin_meta_boxes.post_id,security:wc_gc_admin_params.edit_gift_card_order_item_nonce});e.post(woocommerce_admin_meta_boxes.ajax_url,a,function(a){a.result&&"success"===a.result?(this.$order_items_wrapper.find(".inside").empty(),this.$order_items_wrapper.find(".inside").append(a.html),this.reloaded_items(),"yes"===wc_gc_admin_params.is_wc_version_gte_3_6&&a.notes_html&&(e("ul.order_notes").empty(),e("ul.order_notes").append(e(a.notes_html).find("li"))),this.unblock(this.view.$el.find(".wc-backbone-modal-content")),this.block(),setTimeout(function(){this.unblock()}.bind(this),250),this.view.closeButton(i)):(t.alert(a.error?a.error.replace(/&quot;/g,'"'):wc_gc_admin_params.i18n_validation_error),this.unblock(this.view.$el.find(".wc-backbone-modal-content")))}.bind(this))},populate_form:function(){this.block(this.view.$el.find(".wc-backbone-modal-content"));var i={action:"wc_gc_configure_order_item_gift_card",item_id:this.view._string.item_id,dataType:"json",order_id:woocommerce_admin_meta_boxes.post_id,security:wc_gc_admin_params.edit_gift_card_order_item_nonce};e.post(woocommerce_admin_meta_boxes.ajax_url,i,function(i){if(i.result&&"success"===i.result){var a=this.view.$el.find("form");a.html(i.html),a.wc_gc_datepickers();var n=a.find(".wc-gc-edit-code"),c=n.find('input[type="checkbox"]'),r=n.find(".wc-gc-field");c.is(":checked")||r.show(),c.on("change",function(t){e(this).is(":checked")?r.hide():r.show()}),this.unblock(this.view.$el.find(".wc-backbone-modal-content"))}else t.alert(wc_gc_admin_params.i18n_form_error),this.unblock(this.view.$el.find(".wc-backbone-modal-content")),this.view.$el.find(".modal-close").trigger("click")}.bind(this))},add_gift_card:function(i){var a=t.prompt(wc_gc_admin_params.i18n_wc_add_order_item_prompt);if(null!==a||""!==a){this.block();var n=e("#customer_user").val(),c=e("#_billing_email").val(),r=e.extend({},this.get_taxable_address(),{action:"wc_gc_add_order_item_gift_card",dataType:"json",order_id:woocommerce_admin_meta_boxes.post_id,security:woocommerce_admin_meta_boxes.order_item_nonce,giftcard:a,user_id:n,user_email:c});e.ajax({url:woocommerce_admin_meta_boxes.ajax_url,data:r,type:"POST",success:function(i){i.result&&"success"===i.result?(this.$order_items_wrapper.find(".inside").empty(),this.$order_items_wrapper.find(".inside").append(i.html),"yes"===wc_gc_admin_params.is_wc_version_gte_3_6&&i.notes_html&&(e("ul.order_notes").empty(),e("ul.order_notes").append(e(i.notes_html).find("li"))),this.reloaded_items(),this.unblock()):t.alert(i.data.error),this.unblock()}.bind(this)})}return i.preventDefault(),!1},delete_gift_card:function(i){var a=e(i.target).closest("tr.item, tr.fee, tr.shipping"),n=a.attr("data-gc_code"),c=a.attr("data-order_item_id");if(t.confirm(wc_gc_admin_params.i18n_wc_delete_order_item_warning.replace("%%code%%",n))){this.block();var r=e.extend({},this.get_taxable_address(),{order_id:woocommerce_admin_meta_boxes.post_id,order_item_ids:c,action:"wc_gc_remove_order_item_gift_card",security:woocommerce_admin_meta_boxes.order_item_nonce});"true"===e("button.cancel-action").attr("data-reload")&&(r.items=e("table.woocommerce_order_items :input[name], .wc-order-totals-items :input[name]").serialize()),e.ajax({url:woocommerce_admin_meta_boxes.ajax_url,data:r,type:"POST",success:function(i){i.result&&"success"===i.result?(this.$order_items_wrapper.find(".inside").empty(),this.$order_items_wrapper.find(".inside").append(i.html),"yes"===wc_gc_admin_params.is_wc_version_gte_3_6&&i.notes_html&&(e("ul.order_notes").empty(),e("ul.order_notes").append(e(i.notes_html).find("li"))),this.reloaded_items(),this.unblock()):t.alert(i.data.error),this.unblock()}.bind(this)})}return i.preventDefault(),!1},get_taxable_address:function(){var t="",i="",a="",n="";return"shipping"===woocommerce_admin_meta_boxes.tax_based_on&&(t=e("#_shipping_country").val(),i=e("#_shipping_state").val(),a=e("#_shipping_postcode").val(),n=e("#_shipping_city").val()),"billing"!==woocommerce_admin_meta_boxes.tax_based_on&&t||(t=e("#_billing_country").val(),i=e("#_billing_state").val(),a=e("#_billing_postcode").val(),n=e("#_billing_city").val()),{country:t,state:i,postcode:a,city:n}},core:{init_tiptip:function(){e("#tiptip_holder").removeAttr("style"),e("#tiptip_arrow").removeAttr("style"),e(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200})},stupidtable:{init:function(){e(".woocommerce_order_items").stupidtable(),e(".woocommerce_order_items").on("aftertablesort",this.add_arrows)},add_arrows:function(t,i){var a=e(this).find("th"),n="asc"===i.direction?"&uarr;":"&darr;",c=i.column;a.find(".wc-arrow").remove(),a.eq(c).append('<span class="wc-arrow">'+n+"</span>")}}}}.init();var _=e("div#woocommerce-product-data");if(_.length){var o=_.find("#_virtual"),d=o.parent(),s=o.is(":checked"),l=d.attr("class").split(/\s+/),m=_.find("#product-type"),f=m.val(),u=_.find("#_tax_status"),p=u.val(),h=_.find("#variable_product_options"),g=_.find("#_gift_card"),w=g.parent(),v=w.attr("class").split(/\s+/);g.is(":checked")?a(!0):n(!0),_.on("woocommerce_variations_loaded woocommerce_variations_added",function(){g.is(":checked")?h.find(".variable_is_virtual").prop("checked","checked").each(function(){var t=e(this);t.change(),t.parent().hide()}):i(!1),c()}),g.on("change",function(){e(this).is(":checked")?a():n()}),m.on("change",function(){f=e(this).val(),-1===e.inArray("show_if_"+f,v)?(w.hide(),i(!1)):g.is(":checked")?i():i(!1)}),c()}}),e.fn.wc_gc_datepickers=function(){e(this).find(".datepicker").each(function(t){var i=e(this),a=i.parent().find('input[name="wc_gc_giftcard_delivery"]');i.datepicker({beforeShow:function(t,i){e("#ui-datepicker-div").removeClass("wc_gc_datepicker"),e("#ui-datepicker-div").addClass("wc_gc_datepicker")},minDate:"+1D"});var n=i.datepicker("getDate");if(null!==n&&"function"==typeof n.getTime){var c=new Date;n.setHours(c.getHours(),c.getMinutes()),a.val(n.getTime()/1e3)}i.on("change",function(){var e=i.datepicker("getDate");if(null!==e&&"function"==typeof e.getTime){var t=new Date;e.setHours(t.getHours(),t.getMinutes()),a.val(e.getTime()/1e3)}else a.val("")})})}}(jQuery,window);